<html>
  <head>
    <script src="bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>
    <link rel="import" href="bower_components/voice-elements/dist/voice-player.html">
    <link rel="import" href="bower_components/voice-elements/dist/voice-recognition.html">
    <style>
      p {
        margin: 0;
      }
    </style>
  </head>
  <body>
    <h1>Table tennis scoring apps</h1>
    <p id="speech" ></p>
    <p id="all-speech" style="display:none;"></p>
    <span style="width: 50%; text-align: center; display: inline-block;">
      <p id="blue" style="color: blue; font-size: 70vh;"></p><br />
      <a href="#" onclick=minus('blue')>-</a>
    </span>
    <span style="width: 49%; text-align: center; display: inline-block;">
      <p id="red" style="color: red; font-size: 70vh;"></p><br />
      <a href="#" onclick=minus('red')>-</a>
    </span>
    <div style="text-align: center;"><a href="#" onClick=reset()>New Game</a></div>
    <voice-player id="speaker" autoplay text="Welcome to the tt scoring app"></voice-player>
    <voice-recognition id="recognition-element"></voice-recognition>

<script>
var element = document.querySelector('#recognition-element');
var speaker = document.querySelector('#speaker');
var speech = document.querySelector('#speech');
var all = document.querySelector('#all-speech');
var blue = document.querySelector('#blue');
var red = document.querySelector('#red')
element.start();

var reset = function() {
  blue.innerHTML = '0';
  red.innerHTML = '0';
}

var minus = function(color) {
  var ele;
  if (color == 'blue') {
    ele = blue;
  } else {
    ele = red;
  }
  ele.innerHTML = parseInt(ele.innerHTML) - 1;
}

var adjustScore = function(text) {
  var scored = false;
  if (/((sky|score|school|call).*(blue|glue)|Skoolbo|scorpion)/i.test(text)) {
    blue.innerHTML = parseInt(blue.innerHTML) + 1;
    scored = true;
  }

  if (/((sky|score|school|call).*(red|rent)|pirate|skyrim|torrent|torrid)/i.test(text)) {
    red.innerHTML = parseInt(red.innerHTML) + 1;
    scored = true;
  }

  if (scored || /(status|what.*score)/i.test(text)) {
    speaker.setAttribute('text', 'Blue ' + blue.innerHTML + '. Red ' + red.innerHTML);
    speaker.speak();
  }
}

// Change to use interim text and have a timeout when updating scores
element.addEventListener('result', function(e) {
    var textContent = e.detail.result;
    var newText = textContent.replace(all.innerHTML + ' ','');
    speech.innerHTML = newText;
    adjustScore(newText);
    all.innerHTML = e.detail.result;
});

element.addEventListener('error', function(e) {
    console.log('recording error occurred')
    element.abort();
    setTimeout(function() {
      element.start();
      speaker.setAttribute('text', 'I need permission to continue');
      speaker.speak();
    },3000);
});

// First result after restart includes all text which will count extra points, can we clear history?
element.addEventListener('end', function(e) {
    console.log('recording ended')
    setTimeout(function() {
      element.start();
      speaker.setAttribute('text', 'I need permission to continue');
      speaker.speak();
    },1000);
});

reset();
</script>
  </body>
</html>
