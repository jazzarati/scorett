<html>
  <head>
    <script src="bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>
    <link rel="import" href="bower_components/voice-elements/dist/voice-player.html">
    <link rel="import" href="bower_components/voice-elements/dist/voice-recognition.html">
    <style>
      p {
        margin: 0;
      }
      a {
        text-decoration: none;
      }
    </style>
  </head>
  <body>
    <div style="text-align: center;"><a href="#" onClick=reset()>New Game</a></div>
    <span style="width: 50%; text-align: center; display: inline-block;">
      <a href="#" onclick=add('blue')><p id="blue" style="color: blue; font-size: 70vh;"></p></a><br />
      <a href="#" onclick=minus('blue') style="font-weight: bold;">-</a>
    </span>
    <span style="width: 49%; text-align: center; display: inline-block;">
      <a href="#" onclick=add('red')><p id="red" style="color: red; font-size: 70vh;"></p></a><br />
      <a href="#" onclick=minus('red') style="font-weight: bold;">-</a>
    </span>
    <voice-player id="speaker" autoplay text="Welcome to the tt scoring app"></voice-player>
    <voice-recognition id="recognition-element"></voice-recognition>
    <p id="speech" ></p>
    <p id="all-speech" style="display:none;"></p>

<script>
var element = document.querySelector('#recognition-element');
var speaker = document.querySelector('#speaker');
var speech = document.querySelector('#speech');
var all = document.querySelector('#all-speech');
var blue = document.querySelector('#blue');
var red = document.querySelector('#red')
element.start();

var reset = function() {
  blue.innerHTML = '0';
  red.innerHTML = '0';
}

var add = function(color) {
  var ele;
  if (color == 'blue') {
    ele = blue;
  } else {
    ele = red;
  }
  ele.innerHTML = parseInt(ele.innerHTML) + 1;
}

var minus = function(color) {
  var ele;
  if (color == 'blue') {
    ele = blue;
  } else {
    ele = red;
  }
  ele.innerHTML = parseInt(ele.innerHTML) - 1;
}

var checkScores = function() {
  var blueScore = parseInt(blue.innerHTML);
  var redScore = parseInt(red.innerHTML);
  var minimumWinScore = 11;
  if(blueScore >= minimumWinScore && blueScore - 2 >= redScore) {
    say('Blue wins. ' + blueScore + ' to ' + redScore);
  } else if(redScore >= minimumWinScore && redScore - 2 >= blueScore) {
    say('Red wins. ' + redScore + ' to ' + blueScore);
  } else if(blueScore >= minimumWinScore - 1 && blueScore - 1 >= redScore) {
    say('Blue ' + blue.innerHTML + '. Red ' + red.innerHTML + '. Match point');
  } else if(redScore >= minimumWinScore - 1 && redScore - 1 >= blueScore) {
    say('Blue ' + blue.innerHTML + '. Red ' + red.innerHTML + '. Match point');
  } else {
    say('Blue ' + blue.innerHTML + '. Red ' + red.innerHTML);
  }
}

var adjustScore = function(text) {
  var scored = false;
  if (/((sky|score|school|call).*(blue|glue)|Skoolbo|scorpion)/i.test(text)) {
    blue.innerHTML = parseInt(blue.innerHTML) + 1;
    scored = true;
  }

  if (/((sky|score|school|call).*(red|rent)|pirate|skyrim|torrent|torrid)/i.test(text)) {
    red.innerHTML = parseInt(red.innerHTML) + 1;
    scored = true;
  }

  if (scored || /(status|what.*score)/i.test(text)) {
    checkScores();
  }
}

var say = function(text) {
  speaker.setAttribute('text', text);
  speaker.speak();
}

// Change to use interim text and have a timeout when updating scores
element.addEventListener('result', function(e) {
    var textContent = e.detail.result;
    var newText = textContent.replace(all.innerHTML + ' ','');
    speech.innerHTML = newText;
    adjustScore(newText);
    all.innerHTML = e.detail.result;
});

element.addEventListener('error', function(e) {
    console.log('recording error occurred')
    element.abort();
    setTimeout(function() {
      element.start();
      say('I need permission to continue');
    },3000);
});

// First result after restart includes all text which will count extra points, can we clear history?
element.addEventListener('end', function(e) {
    console.log('recording ended')
    setTimeout(function() {
      element.start();
      say('I need permission to continue');
    },1000);
});

reset();
</script>
  </body>
</html>
